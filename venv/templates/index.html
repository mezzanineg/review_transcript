<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Editor di Trascrizioni Audio</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
      background-color: #f7f7f7;
    }
    .container {
      background-color: white;
      padding: 2em;
      border-radius: 8px;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    textarea {
      width: 100%;
      height: 300px;
      font-size: 1em;
      margin-top: 1em;
    }
    audio {
      width: 100%;
      margin-top: 1em;
    }
    .controls {
      margin-top: 1em;
      display: flex;
      justify-content: space-between;
    }
    select, button {
      padding: 0.5em 1em;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Editor Trascrizioni</h1>

    <label for="fileSelect">Seleziona un file:</label>
    <select id="fileSelect"></select>

    <audio id="audioPlayer" controls></audio>

    <textarea id="transcriptEditor"></textarea>

    <div class="controls">
      <button onclick="loadFile()">Carica</button>
      <button onclick="saveTranscript()">Salva modifiche</button>
    </div>
  </div>

  <script>

    const fileSelect = document.getElementById("fileSelect");
    const transcriptEditor = document.getElementById("transcriptEditor");
    const audioPlayer = document.getElementById("audioPlayer");

    let fileList = [];

    function populateDropdown() {
     fetch('/list-files')
  .then(res => res.json())
  .then(data => {
    const fileSelect = document.getElementById("fileSelect");
    fileSelect.innerHTML = '';
    data.files.forEach(file => {
      const option = document.createElement("option");
      option.value = file;
      option.textContent = file;
      fileSelect.appendChild(option);
    });

    // Carica il primo file se disponibile
    if (data.files.length > 0) {
      fileSelect.value = data.files[0];
      loadFile();
    }
  });
   
    }

    function loadFile() {
        const filename = fileSelect.value;

        // Codifica per URL (gestisce spazi, apostrofi, ecc.)
        const encodedFilename = encodeURIComponent(filename);

        // Carica il file audio
        audioPlayer.src = `/static/audio/${encodedFilename}.mp3`;

        // Carica il file di trascrizione
        fetch(`/static/transcripts/${encodedFilename}.txt`)
            .then(response => {
            if (!response.ok) throw new Error('Errore nel caricamento del file di testo');
            return response.text();
            })
            .then(text => {
            transcriptEditor.value = text;
            })
            .catch(error => {
            transcriptEditor.value = '';
            alert('Errore nel caricamento del file di testo.');
            console.error(error);
            });
    }

    function saveTranscript() {
      const filename = fileSelect.value;
      const updatedText = transcriptEditor.value;

      fetch(`/save`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          filename: filename,
          text: updatedText
        })
      })
      .then(response => {
        if (response.ok) {
          alert("Modifiche salvate.");
        } else {
          alert("Errore nel salvataggio.");
        }
      })
      .catch(error => {
        alert("Errore nella richiesta al server.");
        console.error(error);
      });
    }

    // Carica il primo file all'avvio
    window.onload = populateDropdown;
    fetch('/list-files')
  .then(res => res.json())
  .then(data => {
    fileSelect.innerHTML = '';
    data.files.forEach(file => {
      const option = document.createElement("option");
      option.value = file;
      option.textContent = file;
      fileSelect.appendChild(option);
    });

    if (data.files.length > 0) {
      fileSelect.value = data.files[0];
      loadFile();
    }
  });

// âœ… Quando cambia la selezione nel menu a tendina, carica il nuovo file
fileSelect.addEventListener("change", loadFile);
  </script>
</body>
</html>
